---
name: review-cycle
description: サブエージェント + Codexの並列レビュー → 修正 → 再レビューを両方LGTMが出るまで回す。
user_invocable: true
---

# レビューサイクル

コード品質を担保するための2レビュアー並列レビューサイクル。

## 概要

1. サブエージェント（アーキテクチャ・設計観点）とCodex（実装フィージビリティ観点）を並列起動
2. 両方のフィードバックを統合して修正
3. 再レビューを実行し、両方からLGTMが出るまで繰り返す

## 手順

### Phase 1: レビュー対象の確認

1. **ディレクトリの存在を必ずGlobで確認する**（Exploreエージェントの報告を鵜呑みにしない）
2. レビュー対象のファイル一覧を取得
3. ユーザーにレビュー対象を確認

### Phase 2: 並列レビュー実行

2つのレビュアーを同時に起動する:

#### レビュアーA: サブエージェント（Explore型）
プロンプトテンプレート:
```
以下のディレクトリのコードをレビューしてください。

対象: <ディレクトリパス>

観点:
- アーキテクチャ・設計の一貫性
- 型安全性（asキャスト、Record<string, unknown>の乱用）
- エラーハンドリングの適切さ
- confirm()やalert()の使用（禁止）
- コンポーネントの責務分離
- DRY原則違反
- プロジェクト規約違反（CLAUDE.mdの規約を参照）

結果を以下の形式で出力:
## Critical（必ず修正）
## Warning（修正推奨）
## Info（検討事項）
## 総合判定: LGTM / NOT LGTM
```

#### レビュアーB: Codex
```bash
codex exec --full-auto --sandbox read-only -C "D:\workspace\hono-practice" -o "%TEMP%\codex-output.md" "以下のディレクトリのコードレビューをしてください。<ディレクトリパス> を対象に、実装の正確性・エッジケース・パフォーマンス・セキュリティの観点でCritical/Warning/Infoに分類して指摘してください。最後にLGTM/NOT LGTMの判定を出してください。"
```

### Phase 3: フィードバック統合と修正

1. 両レビュアーの指摘を統合（重複排除）
2. Critical → Warning → Infoの優先順で修正
3. **修正時のファイル分割ルール**: 並列修正する場合は編集対象ファイルが重複しないよう排他的にグループ分け

### Phase 4: 再レビュー

1. 修正内容を含めて再度Phase 2を実行
2. 両方からLGTMが出たら完了
3. NOT LGTMが出たら指摘を修正してPhase 4を繰り返す

## 注意事項

- レビュー対象ディレクトリを間違えない（`apps/frontend` vs `apps/frontend-v2`）
- Codexの `-C` パスは `D:\workspace\hono-practice` を使う
- Codexの出力は `%TEMP%\codex-output.md` からReadツールで読み取る
- サブエージェントの方が細かい指摘を拾う傾向がある。厳しい方に合わせる
- 修正後の再レビューでは、前回の指摘が解消されたことを明示的に確認させる
- **計画書レビューと実装レビューは別物**: 計画書のレビュー済み≠実装コードのレビュー済み。大規模リファクタリングでは実装後にも必ず回す
- Warningでもプロジェクト規約違反（`as`キャスト等）は修正すべきと提案する。「スコープ外」で先送りしない
