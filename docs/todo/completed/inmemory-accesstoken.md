# インメモリアクセストークン管理への移行

## 目的・背景

### 現在の実装の課題

1. **アクセストークンがCookieで管理されている**
   - httpOnly Cookieは安全だが、CSRF攻撃のリスクが存在
   - SameSite属性で緩和されているが、完全ではない

2. **初回APIアクセス時の401エラー処理**
   - ユーザー体験が悪い（エラーが発生してから対処）
   - 無駄なAPIリクエストが発生

### 移行後のメリット

1. **セキュリティの向上**
   - アクセストークンをメモリ内で管理（XSS攻撃時の被害を最小化）
   - Authorizationヘッダーを使用（CSRF攻撃を完全に防止）

2. **UXの改善**
   - 初回起動時にトークンを取得（プロアクティブ）
   - エラーを未然に防ぐ

3. **実装の簡潔化**
   - 401エラー時の複雑なリトライロジックが不要
   - トークン管理の責務が明確化

## タスクリスト

### 1. バックエンドの変更

- [x] `/auth/token` エンドポイントの修正
  - [x] アクセストークンをCookieではなくJSONレスポンスで返すように変更
  - [x] リフレッシュトークンは引き続きhttpOnly Cookieで管理
- [x] 認証ミドルウェア (`authMiddleware.ts`) の修正
  - [x] Cookieからの認証を削除
  - [x] Authorizationヘッダーからのトークン取得を実装
  - [x] Bearer トークン形式のサポート
- [x] ログイン・ログアウトエンドポイントの修正
  - [x] アクセストークンCookieの設定を削除
  - [x] レスポンスボディでアクセストークンを返す

### 2. フロントエンドの変更

- [x] トークン管理の実装
  - [x] メモリ内でアクセストークンを保持するストア/コンテキストの作成
  - [x] トークンの有効期限管理（14分後に自動リフレッシュ）
- [x] `AuthProvider` の修正
  - [x] 初回マウント時に `/auth/token` を呼び出してトークン取得
  - [x] トークン取得失敗時はログイン画面へ遷移
  - [x] トークン取得成功時はメモリに保存
- [x] `apiClient.ts` の修正
  - [x] `credentials: "include"` の削除（リフレッシュトークン用のエンドポイントのみ残す）
  - [x] 全リクエストにAuthorizationヘッダーを追加
  - [x] 401エラー時の自動リトライロジックを削除
  - [x] トークン期限切れ時の処理を簡潔化
- [x] `useAuth` フックの修正
  - [x] メモリ内のトークンを参照するように変更
  - [x] ログイン・ログアウト時のトークン管理

### 3. テストの修正

- [x] バックエンドのテスト修正
  - [x] 認証ミドルウェアのテスト（Authorizationヘッダー対応）
  - [x] 各エンドポイントのテスト（Cookie認証からBearer認証へ）

### 4. モバイルアプリ (React Native) の対応

- [ ] `apiClient.ts` の修正（Authorizationヘッダー対応）
- [ ] トークン管理の実装（React NativeのSecureStore等を検討）
- [ ] 初回起動時のトークン取得フローの実装

### 5. ドキュメンテーション

- [ ] 認証フローの更新（`docs/knowledges/auth_flow.md`）
- [ ] APIドキュメントの更新（認証方式の変更）
- [ ] 移行ガイドの作成（既存ユーザー向け）

## 注意点

- リフレッシュトークンは引き続きhttpOnly Cookieで管理（セキュリティ上重要）
- アクセストークンの有効期限（15分）は変更しない
- 移行期間中は両方の認証方式をサポートすることも検討
