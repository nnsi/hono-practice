# WebアプリとReact Nativeアプリのロジック共通化計画

## 概要
WebアプリとReact Nativeアプリで重複しているビジネスロジック（Hooks）を共通化し、コードの重複を削減する。プラットフォーム固有の実装はAdapter パターンで抽象化する。

## アーキテクチャ概要
```
packages/
├── frontend-shared/       (既存→拡張) - API通信、認証、トークン管理、共通Hooks
│   ├── adapters/         (新規) - プラットフォーム抽象化層
│   ├── hooks/            (新規) - 共通Hooksロジック  
│   └── [既存ファイル]
└── types/                (既存) - リクエスト/レスポンス型定義
```

## INVEST原則に基づくタスクリスト

### Epic 1: Platform Adapters基盤構築 (見積: 4-6日)

#### 1.1 frontend-shared/adaptersディレクトリのセットアップ (0.5日)
- [x] `frontend-shared/adapters`ディレクトリの作成
- [x] adapterインターフェースの基本型定義ファイル作成
- [x] package.jsonのexportsマップ更新（`"./adapters": "./frontend-shared/adapters/index.ts"`）
- [x] TypeScript設定の確認
- **価値**: プラットフォーム抽象化の基盤確立
- **テスト可能**: ビルドとエクスポートの成功を検証

#### 1.2 StorageAdapter インターフェースの定義と実装 (1日)
- [x] StorageAdapter インターフェースの定義
- [x] Web用実装（localStorage使用）
- [x] React Native用実装（AsyncStorage使用）
- [x] ユニットテストの作成
- **価値**: ストレージ操作の統一により、データ永続化ロジックを共通化可能
- **テスト可能**: 各メソッドの動作をモック化してテスト可能

#### 1.3 NetworkAdapter インターフェースの定義と実装 (1日)
- [x] NetworkAdapter インターフェースの定義
- [x] Web用実装（navigator.onLine使用）
- [x] React Native用実装（NetInfo使用）
- [x] ユニットテストの作成
- **価値**: ネットワーク状態管理を統一化
- **テスト可能**: オンライン/オフライン状態の切り替えをテスト可能

#### 1.4 NotificationAdapter インターフェースの定義と実装 (1日)
- [x] NotificationAdapter インターフェースの定義
- [x] Web用実装（toast、alert使用）
- [x] React Native用実装（Alert API使用）
- [x] ユニットテストの作成
- **価値**: ユーザー通知の統一化
- **テスト可能**: 各通知メソッドの呼び出しを検証可能

#### 1.5 EventBusAdapter インターフェースの定義と実装 (0.5日)
- [x] EventBusAdapter インターフェースの定義
- [x] Web用実装（EventEmitter使用）
- [x] React Native用実装（既存eventBus使用）
- [x] ユニットテストの作成
- **価値**: イベント駆動の処理を統一化
- **テスト可能**: イベントの発火と受信を検証可能

#### 1.6 Adapters統合とドキュメント作成 (0.5日)
- [x] adapters/index.tsでのエクスポート整理
- [x] TypeScriptの型定義の最適化
- [x] READMEとAPIドキュメントの作成
- **価値**: 開発者が容易に利用可能
- **テスト可能**: ビルドとエクスポートの成功を検証

### Epic 2: 共通Hooksの実装 (見積: 4-6日)

#### 2.1 frontend-shared/hooksディレクトリのセットアップ (0.5日)
- [x] `frontend-shared/hooks`ディレクトリの作成
- [x] hooksのインデックスファイル作成
- [x] package.jsonのexportsマップ更新（`"./hooks": "./frontend-shared/hooks/index.ts"`）
- [x] テスト環境のセットアップ
- **価値**: 共通ロジックの基盤を確立
- **テスト可能**: エクスポートとテスト実行を検証

#### 2.2 createUseTimerの実装 (2日)
- [x] 共通タイマーロジックの実装
- [x] Platform Adaptersの利用
- [x] 型定義の作成
- [x] ユニットテストの作成（モックAdapter使用）
- [x] ドキュメントの作成
- **価値**: タイマー機能を両プラットフォームで共通化
- **テスト可能**: タイマーの開始、停止、リセット機能を検証

#### 2.3 createUseNetworkStatusの実装 (1日)
- [x] 共通ネットワーク状態管理ロジックの実装
- [x] オンライン/オフライン検知の統一
- [x] 型定義の作成
- [x] ユニットテストの作成
- **価値**: ネットワーク状態管理を共通化
- **テスト可能**: 状態変化の検知と通知を検証

#### 2.4 createUseGlobalDateの実装 (0.5日)
- [x] 共通日付管理ロジックの実装
- [x] 型定義の作成
- [x] ユニットテストの作成
- **価値**: 日付管理ロジックを共通化
- **テスト可能**: 日付の操作と表示を検証

#### 2.5 createUseLongPressの実装 (1日)
- [x] 共通長押し検知ロジックの実装
- [x] プラットフォーム固有のイベント処理の抽象化
- [x] 型定義の作成
- [x] ユニットテストの作成
- **価値**: UI操作の共通化
- **テスト可能**: 長押しイベントの検知を検証

### Epic 3: 既存コードの移行 - Phase 1 (見積: 4-5日)

#### 3.1 Web版useTimerの移行 (1日)
- [x] 既存実装のバックアップ
- [x] createUseTimerを使った新実装の作成
- [x] 既存テストの動作確認
- [x] 統合テストの実施
- [x] 段階的な切り替え
- **価値**: 重複コードの削減開始
- **テスト可能**: 既存機能の維持を検証

#### 3.2 Mobile版useTimerの移行 (1日)
- [x] 既存実装のバックアップ
- [x] createUseTimerを使った新実装の作成
- [x] 既存テストの動作確認
- [x] 統合テストの実施
- **価値**: タイマーロジックの統一完了
- **テスト可能**: モバイルアプリでの動作を検証

#### 3.3 Web版useNetworkStatusの移行 (0.5日)
- [x] 既存実装のバックアップ
- [x] createUseNetworkStatusを使った新実装
- [x] テストの更新と実行
- **価値**: ネットワーク状態管理の統一
- **テスト可能**: Web環境での動作を検証

#### 3.4 Mobile版useNetworkStatusの移行 (0.5日)
- [x] 既存実装のバックアップ
- [x] createUseNetworkStatusを使った新実装
- [x] テストの更新と実行
- **価値**: ネットワーク状態管理の完全統一
- **テスト可能**: モバイル環境での動作を検証

#### 3.5 Phase 1の統合テストとドキュメント更新 (1日)
- [x] 両プラットフォームでの統合テスト
- [x] パフォーマンステスト
- [x] 移行ガイドの作成
- [x] CLAUDEm.mdの更新
- **価値**: 安定性の確保と開発者体験の向上
- **テスト可能**: エンドツーエンドの動作を検証

### Epic 4: API関連Hooksの共通化準備 (見積: 3-4日)

#### 4.1 API通信層の抽象化設計 (1日)
- [x] HTTPクライアントの抽象化インターフェース設計
- [x] エラーハンドリングの統一方針決定
- [x] キャッシュ戦略の設計
- **価値**: API通信の共通化基盤
- **テスト可能**: 設計ドキュメントのレビュー
- **成果物**: `/docs/etc/api-abstraction-design.md`

#### 4.2 認証フローの共通化設計 (1日)
- [x] トークン管理の抽象化設計
- [x] 認証状態管理の統一設計
- [x] セキュリティ要件の確認
- **価値**: 認証ロジックの統一準備
- **テスト可能**: セキュリティレビューの実施
- **成果物**: `/docs/etc/auth-common-design.md`

#### 4.3 プロトタイプの作成 (1日)
- [ ] useActivitiesの共通化プロトタイプ
- [ ] 実装可能性の検証
- [ ] パフォーマンス影響の評価
- **価値**: 実装リスクの早期発見
- **テスト可能**: プロトタイプの動作検証

### Epic 5: 継続的改善とモニタリング (継続的)

#### 5.1 パフォーマンスモニタリングの設定 (0.5日)
- [ ] バンドルサイズの監視設定
- [ ] 実行時パフォーマンスの計測
- [ ] レポートの自動化
- **価値**: パフォーマンス劣化の防止
- **テスト可能**: 計測値の閾値チェック

#### 5.2 開発者フィードバックの収集システム (0.5日)
- [ ] フィードバック収集方法の確立
- [ ] 改善提案の管理プロセス
- [ ] 定期的なレビュー会議の設定
- **価値**: 継続的な改善
- **テスト可能**: フィードバックループの機能

## 成功基準

1. **コード重複率の削減**: 共通化対象のHooksで80%以上の重複削減
2. **テストカバレッジ**: 共通Hooksで90%以上のカバレッジ
3. **パフォーマンス**: 既存実装と比較して±5%以内の性能
4. **開発者満足度**: 新しいHooksの追加が50%高速化
5. **パッケージサイズ**: frontend-sharedパッケージの増加を最小限に抑える

## リスクと対策

1. **リスク**: プラットフォーム固有の挙動の違い
   - **対策**: 十分なAdapter層のテストと、段階的な移行

2. **リスク**: バンドルサイズの増加
   - **対策**: Tree-shakingの最適化と、動的インポートの活用

3. **リスク**: 既存機能への影響
   - **対策**: Feature flagによる段階的な切り替え

## 次のステップ

1. このタスクリストのレビューと承認
2. Epic 1の開始（Platform Adapters基盤構築）
3. 週次進捗レビューの実施

## 参考資料

- [Adapter Pattern](https://refactoring.guru/design-patterns/adapter)
- [INVEST原則](https://www.agilealliance.org/glossary/invest)
- [React Hook Testing](https://react-hooks-testing-library.com/)