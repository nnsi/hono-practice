# オフライン対応実装タスクリスト（ハイブリッド方式）

## Week 1: バックエンド基盤実装

### 準備・計画フェーズ
- [x] ハイブリッド方式オフライン対応実装計画の策定と承認
- [x] 同期機能のドメインモデル設計

### ドメインモデル実装（2日）

#### Syncドメインモデルの作成
- [x] `backend/domain/sync/` ディレクトリ作成
- [x] `SyncMetadata` エンティティの実装
  - [x] エンティティ型定義（Zodスキーマ）
  - [x] ID型の定義（`SyncMetadataId`）
  - [x] ファクトリ関数（`createSyncMetadataEntity`）
  - [x] 同期状態の管理（pending, syncing, synced, failed）
- [x] `SyncQueue` エンティティの実装
  - [x] 未同期データのキュー管理
  - [x] エンティティ型、操作種別（create, update, delete）
  - [x] タイムスタンプとペイロード管理
- [x] データベーススキーマの作成
  - [x] `sync_metadata` テーブル定義
  - [x] `sync_queue` テーブル定義
  - [x] マイグレーションファイル生成

### 同期機能の実装（2日）

#### Syncリポジトリ層
- [x] `backend/feature/sync/repository.ts` の実装
  - [x] `findDuplicatesByTimestamps` - タイムスタンプ重複チェック
  - [x] `getSyncStatus` - ユーザーごとの同期状況取得
  - [x] `enqueueSync` - 同期キューへの追加
  - [x] `dequeueSyncBatch` - バッチ単位での取り出し
  - [x] `markAsSynced` - 同期完了マーキング

#### Syncユースケース層
- [x] `backend/feature/sync/usecase.ts` の実装
  - [x] `checkDuplicatesUseCase` - 重複チェックロジック
  - [x] `getSyncStatusUseCase` - 同期状況集計
  - [x] `processSyncQueueUseCase` - キュー処理ロジック

#### SyncハンドラーとAPI
- [x] `backend/feature/sync/handler.ts` の実装
  - [x] `POST /users/sync/check-duplicates` エンドポイント
  - [x] `GET /users/sync/status` エンドポイント
  - [x] 認証ミドルウェアの適用
  - [x] エラーハンドリング
- [x] ルーティング設定
  - [x] `backend/app.ts` へのルート追加
  - [x] APIドキュメント更新

### テスト実装（1日）
- [x] Syncドメインモデルのユニットテスト
  - [x] エンティティ生成テスト
  - [x] バリデーションテスト
  - [x] 状態遷移テスト
- [x] Syncリポジトリのテスト
  - [x] モックDBを使用したCRUDテスト
  - [x] 重複チェックロジックのテスト
- [x] Syncユースケースのテスト
  - [x] ビジネスロジックのテスト
  - [x] エラーケースのテスト
- [x] APIエンドポイントのインテグレーションテスト
  - [x] 認証付きリクエストのテスト
  - [x] レスポンス形式の検証

### バックエンドの残タスク

#### 同期APIの追加実装
- [x] `POST /sync/batch` - バッチ同期エンドポイント
  - [x] 複数のエンティティを一度に同期
  - [x] トランザクション制御
  - [x] 成功/失敗の詳細レスポンス
- [x] `GET /sync/queue` - ユーザーの同期キュー取得
  - [x] ペンディング中の同期操作一覧
  - [x] ページネーション対応
- [x] `DELETE /sync/queue/:id` - 同期キューアイテムの削除
  - [x] 特定の同期操作をキャンセル
  - [x] 権限チェック

#### 各エンティティの同期処理実装
- [x] Activity同期処理の実装
  - [x] 同期ミドルウェアによる自動同期キュー登録
  - [x] 作成・更新・削除の同期処理
  - [x] コンフリクト解決ロジック（最終更新日時ベース）
- [x] ActivityLog同期処理の実装
  - [x] 同期ミドルウェアによる自動同期キュー登録
  - [x] 作成・更新・削除の同期処理
  - [x] Activity/ActivityKind参照整合性チェック
- [x] Task同期処理の実装
  - [x] 同期ミドルウェアによる自動同期キュー登録
  - [x] 作成・更新・削除の同期処理
  - [ ] ステータス変更の競合解決
- [x] Goal同期処理の実装
  - [x] 同期ミドルウェアによる自動同期キュー登録
  - [x] 作成・更新・削除の同期処理

#### 同期処理の統合
- [x] 同期ミドルウェア (`syncMiddleware`) の実装
  - [x] HTTPレスポンスベースの自動同期キュー登録
  - [x] エンドポイントパターンによる操作タイプの自動判定
  - [x] エラーハンドリング（同期エラーでもリクエストは失敗させない）
  - [x] テスト環境での無効化
- [x] 各ルートへの同期ミドルウェア適用
  - [x] `ActivityRoute` への適用
  - [x] `ActivityLogRoute` への適用
  - [x] `TaskRoute` への適用
  - [x] `GoalRoute` への適用
- [x] `syncService`の実装
  - [x] entityTypeに応じた適切なリポジトリメソッドの呼び出し
  - [x] エラーハンドリングとリトライロジック
  - [x] トランザクション管理
- [x] 同期用のDTOとマッピング
  - [x] クライアント側のペイロードから各エンティティへの変換
  - [x] バージョン管理フィールドの追加（BatchSyncRequest/Response）
  - [x] Pull型同期用DTO（PullSyncRequest/Response）の追加

#### Pull型同期API
- [x] `GET /sync/pull` - Pull型同期エンドポイント
  - [x] 最終同期タイムスタンプからの差分取得
  - [x] エンティティタイプ別フィルタリング
  - [x] ページネーション対応（limit/cursor）
  - [x] 各リポジトリへの固有`getChangesAfter`メソッド追加
    - [x] `getActivityChangesAfter`
    - [x] `getActivityLogChangesAfter`
    - [x] `getTaskChangesAfter`
    - [x] `getGoalChangesAfter`
  - [x] Pull同期テストの実装

#### 同期の最適化
- [ ] バルク操作の実装
  - [ ] 複数のActivityLogを一度に同期
  - [ ] パフォーマンス最適化
- [x] 同期順序の保証
  - [x] 依存関係のあるエンティティの順序制御
  - [x] Activity → ActivityKind → ActivityLogの順序保証
- [ ] 部分同期のサポート
  - [ ] 特定期間のデータのみ同期
  - [ ] 差分同期の実装
- [x] 同期の信頼性向上
  - [x] 冪等性の保証（重複実行しても安全）
  - [ ] 同期履歴の記録
  - [ ] 同期失敗時の通知機能

## Week 2: フロントエンド実装

### 準備フェーズ
- [ ] 必要な依存関係のインストール
  - [ ] `npm install @tanstack/react-query-persist-client`
  - [ ] `npm install @tanstack/query-sync-storage-persister`

### フロントエンド基盤実装（3日）

#### ネットワーク状態検知（0.5日）
- [ ] `frontend/hooks/useNetworkStatus.ts` の作成
  - [ ] `navigator.onLine` を使用した基本実装
  - [ ] ネットワーク状態変更イベントリスナーの追加
  - [ ] 型定義（`NetworkStatus` 型）
- [ ] `frontend/providers/NetworkStatusProvider.tsx` の作成
  - [ ] React Context でアプリ全体へ状態を提供
  - [ ] 子コンポーネントへの状態伝播

#### React Query永続化設定（0.5日）
- [ ] React Query の永続化設定実装
  - [ ] `createSyncStoragePersister` の設定
  - [ ] `QueryClient` のキャッシュ時間設定（24時間）
  - [ ] localStorage をストレージバックエンドとして設定
- [ ] アプリケーションエントリポイントの更新
  - [ ] `main.tsx` で `PersistQueryClientProvider` に変更
  - [ ] 永続化オプションの設定

#### 同期システムの実装（2日）

##### 同期サービス層の作成
- [ ] `frontend/services/sync/` ディレクトリ作成
- [ ] `SyncQueue` クラスの実装
  - [ ] 未同期データのメモリ内キュー管理
  - [ ] localStorage への永続化処理
  - [ ] FIFO順序でのデータ取り出し
- [ ] `SyncManager` クラスの実装
  - [ ] オンライン復帰時の自動同期トリガー
  - [ ] バックエンドAPIとの通信処理
  - [ ] 重複チェックロジックの実装
  - [ ] エラーハンドリングとリトライ

##### React Queryとの統合
- [ ] カスタムミューテーションフックの作成
  - [ ] `useSyncedMutation` - オフライン対応ミューテーション
  - [ ] `resumePausedMutations()` の組み込み
  - [ ] 同期状態の管理
- [ ] 既存のデータ送信フックの改修
  - [ ] 活動記録送信の同期対応
  - [ ] タスク更新の同期対応

### UI/UX実装（2日）

#### 同期状態表示コンポーネント（1日）
- [ ] `frontend/components/sync/SyncStatusIndicator.tsx` の作成
  - [ ] オンライン/オフラインアイコン表示
  - [ ] 未同期データ件数バッジ
  - [ ] 同期中のローディングアニメーション
- [ ] `frontend/components/sync/SyncProgressBar.tsx` の作成
  - [ ] 同期進捗のパーセンテージ表示
  - [ ] アニメーション付きプログレスバー
- [ ] `frontend/components/sync/OfflineBanner.tsx` の作成
  - [ ] オフライン時の通知バナー
  - [ ] 自動非表示タイマー

#### 既存コンポーネントへの統合（1日）
- [ ] ヘッダーコンポーネントへの同期状態表示追加
- [ ] 活動記録リストへの未同期マーク追加
  - [ ] 未同期データのスタイリング（opacity等）
  - [ ] 同期待ちアイコンの表示
- [ ] エラーハンドリングの実装
  - [ ] 同期エラー時のトースト通知
  - [ ] リトライボタンの追加

### フロントエンドテスト実装（1日）
- [ ] 同期システムのユニットテスト
  - [ ] `SyncQueue` クラスのテスト
  - [ ] `SyncManager` クラスのテスト
  - [ ] localStorage 永続化のテスト
- [ ] React フックのテスト
  - [ ] `useNetworkStatus` のテスト
  - [ ] `useSyncedMutation` のテスト
- [ ] コンポーネントのテスト
  - [ ] 同期状態表示コンポーネントのテスト
  - [ ] オフラインバナーのテスト

## Week 3: 統合テスト・品質保証

### 統合テスト（2日）

#### E2Eシナリオテスト
- [ ] オフライン記録フローのE2Eテスト
  - [ ] ネットワーク切断状態での記録作成
  - [ ] オンライン復帰時の自動同期確認
  - [ ] UIの状態遷移確認
- [ ] エラーリカバリーテスト
  - [ ] API エラー時のリトライ動作
  - [ ] 部分的な同期失敗からの回復
  - [ ] タイムアウト処理の確認

#### パフォーマンステスト
- [ ] 大量データ同期のベンチマーク
  - [ ] 100件、500件、1000件でのテスト
  - [ ] メモリ使用量の計測
  - [ ] 同期時間の計測
- [ ] localStorage 容量テスト
  - [ ] 容量上限付近での動作確認
  - [ ] 自動クリーンアップの検証

### 最適化と改善（2日）

#### パフォーマンス最適化
- [ ] 同期バッチサイズの調整
  - [ ] 最適なバッチサイズの決定
  - [ ] ネットワーク状況に応じた動的調整
- [ ] UI応答性の改善
  - [ ] 同期処理の Web Worker 化検討
  - [ ] レンダリング最適化
  - [ ] 不要な再レンダリング削除

#### 品質改善
- [ ] エラーメッセージの改善
  - [ ] ユーザーフレンドリーなメッセージ
  - [ ] 対処方法の提示
- [ ] ログとモニタリング
  - [ ] 同期イベントのログ記録
  - [ ] エラー追跡の実装

### ドキュメント整備（1日）
- [ ] ユーザー向けドキュメント
  - [ ] オフライン機能の使い方ガイド
  - [ ] よくある質問（FAQ）
  - [ ] トラブルシューティング
- [ ] 技術ドキュメント
  - [ ] 同期アーキテクチャの説明
  - [ ] API仕様書（OpenAPI形式）
  - [ ] デプロイメントガイド

## リリース準備

### 最終確認（0.5日）
- [ ] 全機能の動作確認
  - [ ] チェックリストに基づく確認
  - [ ] 主要シナリオの手動テスト
- [ ] パフォーマンス指標の確認
  - [ ] 同期成功率95%以上の達成
  - [ ] レスポンスタイムの計測
- [ ] セキュリティレビュー
  - [ ] 認証トークンの適切な管理
  - [ ] データの暗号化確認

### デプロイメント（0.5日）
- [ ] ステージング環境へのデプロイ
  - [ ] 環境変数の設定
  - [ ] 動作確認
- [ ] 本番環境へのデプロイ準備
  - [ ] リリースノート作成
  - [ ] ロールバック計画の策定
  - [ ] モニタリング設定

## 追加で必要なAPI側の実装

### コンフリクト解決機能
- [x] `ConflictResolver` サービスの実装
  - [x] タイムスタンプベースの解決戦略
  - [x] クライアント優先/サーバー優先の選択
  - [ ] マージ戦略（フィールドレベル）
- [x] コンフリクト検出機能
  - [x] バッチ同期APIでのコンフリクト検出
  - [x] コンフリクトの詳細情報返却（conflictDataフィールド）
  - [x] 解決戦略の選択（strategyパラメータ）

### データ整合性チェック
- [ ] 整合性検証バッチ処理
  - [ ] 定期的なデータ整合性チェック
  - [ ] 不整合データの自動修復
  - [ ] アラート通知
- [ ] 手動整合性チェックAPI
  - [ ] `POST /sync/validate`
  - [ ] ユーザーデータの整合性レポート

## 成功指標
- [ ] **記録断絶ゼロ**: オフライン時でも記録が可能
- [ ] **同期成功率 > 95%**: 高い信頼性の確保
- [ ] **ユーザー体験**: シームレスなオフライン/オンライン切り替え
- [ ] **パフォーマンス**: 既存機能への影響なし