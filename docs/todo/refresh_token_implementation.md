# リフレッシュトークン実装タスクリスト

## 概要

- アクセストークン有効期限: 15分
- リフレッシュトークン有効期限: 1ヶ月
- アクセストークン: JWT形式
- リフレッシュトークン: DB保存
- トークン無効化: ログアウト時のみ

## ドメインモデル層

- [x] リフレッシュトークンのドメインモデル作成
  - [x] スキーマ定義（Zod）
  - [x] エンティティの作成
  - [x] バリデーションルールの実装
  - [x] トークン生成ロジックの実装
  - [x] 有効期限設定の実装

## インフラストラクチャ層

- [x] リフレッシュトークンリポジトリの実装
  - [x] トークンの保存処理
  - [x] トークンの検索処理
  - [x] トークンの無効化処理
  - [x] 期限切れトークンの削除処理
  - [x] トークンの暗号化処理

## ユースケース層

- [x] 認証関連のユースケース実装
  - [x] リフレッシュトークンの生成処理
  - [x] アクセストークンの更新処理
  - [x] トークンの検証処理
  - [x] トークンの無効化処理

## アプリケーション層

- [x] 認証ミドルウェアの修正
  - [x] アクセストークンの検証処理
  - [x] リフレッシュトークンの検証処理
  - [x] トークンの更新処理

## プレゼンテーション層

- [x] 認証エンドポイントの実装
  - [x] `/auth/token` エンドポイントの実装
    - [x] リフレッシュトークンによるアクセストークン更新処理
  - [x] `/auth/logout` エンドポイントの修正
    - [x] リフレッシュトークンの無効化処理

## テスト

- [ ] ドメインモデルのテスト
  - [ ] スキーマのバリデーションテスト
  - [ ] トークン生成のテスト
  - [ ] 有効期限のテスト
- [x] リポジトリのテスト
  - [x] トークン保存のテスト
  - [x] トークン検索のテスト
  - [x] トークン無効化のテスト
  - [ ] トークンの暗号化テスト
- [x] ユースケースのテスト
  - [x] トークン更新のテスト
  - [x] トークン検証のテスト
- [x] エンドポイントのテスト
  - [x] `/auth/token` のテスト
  - [x] `/auth/logout` のテスト

## セキュリティ対策

- [x] トークンの暗号化
  - [x] リフレッシュトークンの暗号化方式の決定
  - [x] 暗号化処理の実装
- [x] トークンの無効化
  - [x] ログアウト時の無効化処理
  - [x] 期限切れトークンの自動無効化
- [x] セキュアなクッキー設定
  - [x] クッキーのセキュアフラグ設定
  - [x] クッキーのHTTPOnly設定
  - [x] クッキーのSameSite設定

## フロントエンド実装

### 1. `apps/frontend/src/utils/apiClient.ts`の修正

- [x] リフレッシュトークンをlocalStorageに保存する機能の追加
- [x] 401エラー時のリフレッシュトークンによる再試行処理の実装
- [x] リフレッシュトークンが無効な場合のログアウト処理の実装

### 2. `apps/frontend/src/providers/AuthProvider.tsx`の修正

- [x] リフレッシュトークンの状態管理の追加
- [x] ログイン時のリフレッシュトークン保存処理の実装
- [x] ログアウト時のリフレッシュトークン削除処理の実装
- [x] トークンリフレッシュ関数の実装
- [x] 自動トークンリフレッシュの仕組みの実装

### 3. `apps/frontend/src/routes/__root.tsx`の修正

- [x] unauthorizedイベントハンドラーの修正
  - [x] トークンリフレッシュの試行
  - [x] リフレッシュ失敗時のみログイン画面へリダイレクト

### 4. `apps/frontend/src/components/root/LoginForm.tsx`の修正

- [x] リフレッシュトークンの保存処理の追加
- [x] ログイン成功時のレスポンス処理の修正

### 5. `apps/frontend/src/components/root/CreateUserForm.tsx`の修正

- [x] リフレッシュトークンの保存処理の追加
- [x] ユーザー作成成功時のレスポンス処理の修正

### セキュリティ対策（フロントエンド）

- [x] リフレッシュトークンの安全な保存方法の実装
- [x] トークンの有効期限チェックの実装
- [x] トークンのセキュアな更新処理の実装

### エラーハンドリング

- [x] トークンリフレッシュ失敗時の適切なエラー処理
- [x] ネットワークエラー時のリトライ処理
- [x] 無限ループ防止の実装
