# Activity Original Icon 機能実装タスクリスト

## 概要
Activityにオリジナルアイコンをアップロード・生成して使える機能を追加します。
現在の絵文字機能に加えて、画像アップロードとAI画像生成機能を実装します。

## 設計方針
1. 既存の絵文字機能との互換性を保つ
2. INVEST原則に基づいたタスク設計（Independent, Negotiable, Valuable, Estimable, Small, Testable）
3. 各タスクは独立して実装・テスト可能
4. 明確な受入基準による品質保証

## 主要機能タスクリスト

| ID | タスク | 説明 | 受入基準 | 見積 |
| --- | --- | --- | --- | --- |
| AOI-1 | データベーススキーマ拡張 | Activityテーブルに`icon_type`、`icon_url`、`icon_thumbnail_url`カラムを追加するマイグレーションを作成・適用 | 1. マイグレーション適用後に3つのカラムが存在<br>2. 既存データは`icon_type='emoji'`で問題なく動作<br>3. 新規作成時にデフォルト値が設定される | 2h |

| AOI-2 | ドメインモデル・DTO更新 | Activity型定義とリクエスト/レスポンスDTOに新しいフィールドを追加し、バリデーションルールを実装 | 1. Activity型に3つの新フィールドが定義される<br>2. DTOが更新され型エラーがない<br>3. iconType別のバリデーションテストが通る | 3h |

| AOI-3 | ストレージサービス実装 | S3/ローカルに依存しない`StorageService`インターフェースを定義し、環境変数で実装を切り替え可能にする | 1. `StorageService.upload()`でファイルを保存しURLを返す<br>2. 環境変数でlocal/s3を切り替えられる<br>3. ユニットテストが通る | 4h |

| AOI-4 | 画像バリデーション実装 | ファイルサイズ・拡張子・解像度をサーバー側で検証するミドルウェアとバリデーション関数を実装 | 1. 5MB超過で422エラー<br>2. 非画像ファイルで422エラー<br>3. 正常画像でバリデーション成功 | 2h |
| AOI-5 | アイコンアップロードAPI | `POST /api/v1/activities/:id/icon`でmultipart画像を受け取り、StorageServiceに保存後DBを更新 | 1. Postmanで200応答<br>2. DBのicon_type='upload'、icon_urlが更新<br>3. 画像ファイルが保存される | 3h |
| AOI-6 | アイコン削除API | `DELETE /api/v1/activities/:id/icon`で既存アイコンを削除し、絵文字に戻す | 1. ファイルが削除される<br>2. icon_type='emoji'に戻る<br>3. 200応答を返す | 1h |

| AOI-7 | サムネイル生成処理 | 512x512へのリサイズ、背景透過を保持したサムネイル生成ジョブを実装 | 1. アップロード/生成直後にジョブが実行<br>2. サムネイルURLがDBに保存<br>3. アスペクト比と透過が保持される | 3h |

| AOI-8 | フロント：アイコン種別選択UI | Emoji/Upload/Generateを選択できるラジオボタンをActivity作成/編集フォームに追加 | 1. ラジオ切替で各UIが表示<br>2. 既存の絵文字選択と共存<br>3. 選択状態が保持される | 2h |
| AOI-9 | フロント：アップロードUI | ドラッグ&ドロップ対応、プレビュー、進捗バー付きのアップロードコンポーネントを実装 | 1. 画像選択でプレビュー表示<br>2. D&Dで画像を受け付ける<br>3. アップロード進捗が見える | 3h |
| AOI-10 | フロント：既存画面への統合 | Activity一覧/詳細でアイコンを正しく表示し、作成/編集ダイアログに新UIを統合 | 1. iconTypeに応じた表示切替<br>2. サムネイルURLを優先表示<br>3. 編集時に現在の状態を反映 | 2h |

| AOI-11 | 権限チェック実装 | アイコン変更はActivity作成者または管理者のみ許可する権限チェックをAPIに追加 | 1. 権限がない場合403応答<br>2. 作成者と管理者は変更可能<br>3. テストで権限動作を確認 | 2h |

| AOI-12 | E2Eテスト実装 | アップロード/削除フローを含むCypress/Playwrightテストを追加 | 1. CI上でテストがパス<br>2. エラーケースもカバー<br>3. 主要な画面遷移を網羅 | 3h |
| AOI-13 | ドキュメント更新 | README・API仕様書にアイコン機能の使い方を追記 | 1. エンドポイント仕様が記載<br>2. 環境変数の説明を追加<br>3. PRレビューで承認 | 2h |
| AOI-14 | モニタリング設定 | アップロード失敗率・ストレージ使用量を可視化 | 1. ダッシュボードで確認可能<br>2. 閾値超過でアラート発報<br>3. ログが適切に出力される | 2h |

## オプション機能タスクリスト

| ID | タスク | 説明 | 受入基準 | 見積 |
| --- | --- | --- | --- | --- |
| OPT-1 | AI画像生成API | `POST /api/v1/activities/:id/icon/generate`でプロンプトから画像を生成する外部APIと連携 | 1. 200応答で生成画像URLを返す<br>2. 生成画像がDBに保存される<br>3. モック実装で開発可能 | 3h |
| OPT-2 | フロント：画像生成UI | プロンプト入力→生成→プレビュー→保存のフローを実装 | 1. 生成中はローディング表示<br>2. プレビュー後に保存可能<br>3. エラー時は再試行可能 | 3h |
| OPT-3 | 非同期サムネイル生成 | サムネイル生成を非同期ジョブキューで処理し、大量アップロードに対応 | 1. アップロード直後は元画像を返す<br>2. ジョブ完了後にサムネイルURL更新<br>3. ジョブ失敗時のリトライ機能 | 4h |
| OPT-4 | S3/R2ストレージ対応 | Cloudflare R2またはAWS S3への画像保存実装を追加 | 1. 環境変数でストレージ切替<br>2. 既存ローカル実装と互換性維持<br>3. CDN URLでの配信対応 | 4h |

## 実装順序と依存関係

### フェーズ1: 基盤構築（1-2日）
- AOI-1, AOI-2, AOI-3を並行実装可能
- データベースとドメインモデルの基盤を整備

### フェーズ2: バックエンドAPI（2-3日）
- AOI-4, AOI-5, AOI-6, AOI-7を実装
- AOI-11（権限チェック）も同時に実装

### フェーズ3: フロントエンド（2日）
- AOI-8, AOI-9, AOI-10を実装
- バックエンドAPIと並行開発可能（モックで開発）

### フェーズ4: 品質保証（1-2日）
- AOI-12, AOI-13, AOI-14を実装
- 本番リリース前の必須タスク

### 総工数見積: 6-9日（必須機能のみ）

## リスクと対策

| リスク | 影響 | 対策 |
| --- | --- | --- |
| Cloudflare Workersのファイルサイズ制限 | 大きな画像のアップロード不可 | 初期は5MB制限、必要に応じてR2/S3移行（OPT-4） |
| サムネイル生成のパフォーマンス | アップロード応答が遅い | 初期は同期処理、問題があれば非同期化（OPT-3） |
| 不正なファイルアップロード | セキュリティリスク | 厳密なバリデーション（AOI-4）と権限チェック（AOI-11） |
| ストレージ容量の逼迫 | サービス停止リスク | モニタリング（AOI-14）で早期発見、容量アラート設定 |

## 成功指標

1. **機能完成度**: 全ての必須タスク（AOI-1〜14）が完了
2. **品質**: E2Eテストのパス率100%、単体テストカバレッジ80%以上
3. **パフォーマンス**: 画像アップロード応答時間2秒以内（5MB画像）
4. **可用性**: アップロード成功率99%以上（モニタリングで計測）