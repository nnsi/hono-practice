# スタンドアロン版ロードマップ

このドキュメントでは、既存アプリケーションを「バックエンドに依存しない *完全スタンドアロン* ウェブアプリ」に進化させるための段階的ロードマップを示します。まずは Web フロントエンドのみで動作することを目的とし、将来的なモバイル／デスクトップ展開も視野に入れます。

---

## 0. ゴール定義

* **ネットワークが無くても動作**：オフライン状態でも主要機能が利用できる。
* **自己完結したデータ管理**：ローカルに安全にデータを保持し、必要に応じてエクスポート／インポートが可能。
* **ビルド成果物は純粋な静的ファイル**：公開は CDN・GitHub Pages などにアップロードするだけ。
* **PWA 対応**：ホーム画面追加・オフラインキャッシュ・更新通知を提供。

---

## 1. 現行依存関係の棚卸し _(2 週間)_

| 項目 | 例 | アクション |
| ---- | --- | ---------- |
| 認証 | JWT, Cookie セッション | バックエンド排除。ローカルユーザ or 端末固有 ID に置換 |
| データ取得 | REST / GraphQL API | モック化 & IndexedDB 持ち替え |
| ファイルアップロード | S3/Cloudflare R2 | ブラウザ FileSystem Access API / Web Share Target へ |
| 決済 | Stripe | スタンドアロンでは非対応（別フェーズ） |

*コードレベルで外部呼び出し点を列挙し、API 境界を抽象クラスに置換します。*

---

## 2. ストレージ戦略設計 _(1 週間)_

1. IndexedDB + Dexie.js によるオブジェクト保存
2. `localStorage` は小規模設定値のみ
3. エクスポート／インポート用に JSON / CSV 出力フォーマットを定義
4. マイグレーション機構（バージョニング、スキーマ管理）

---

## 3. API 抽象レイヤー実装 _(2 週間)_

```
src/core/api/
  |- index.ts         // Facade
  |- repositories/    // 永続層 (IndexedDB)
  |- mocks/           // 既存 API 互換のモック
```

* アプリ内部は **API Facade** にだけ依存し、実装切り替えを DI で制御。
* エンドポイント URL や `fetch` 呼び出しはすべて Facade より下層に隔離。

---

## 4. 認証 & ユーザ管理 _(1 週間)_

* ゲストユーザを基本とし、端末固有の UUID を自動発行
* 任意で「端末 PIN」など簡易認証を用意（生体認証 API は後続）

---

## 5. オフライン対応 & PWA 化 _(2 週間)_

1. Workbox でリソースキャッシュ戦略を実装
2. Service Worker 更新検知と UI 通知
3. `manifest.webmanifest` を整備（アイコン、テーマカラー等）
4. `beforeinstallprompt` イベントフローを追加

---

## 6. オンライン同期 & バックアップ _(3 週間)_

* **バックグラウンド同期**：`SyncManager` (Service Worker + IndexedDB ウォッチャ) を実装し、オンライン時は **5 分間隔**で差分をバックエンド REST API にプッシュ／プルします。
    * `navigator.onLine` と `online` / `offline` イベントで状態監視
    * Periodic Background Sync API が利用可能なブラウザではそれを優先的に使用
* **衝突解決**：`updatedAt` タイムスタンプ + 操作ログベースの *last-write-wins* 方式。将来的には CRDT の導入を検討
* **キューイング**：オフライン時の変更を `outbox` テーブルに一時保存し、再接続時にリトライ
* **セキュア通信**：Phase 4 で導入する JWT 認証を使い HTTPS エンドポイントへ同期
* **バックアップ**：ユーザ操作でエクスポート / インポート (JSON / ZIP) も引き続き提供

---

## 7. UI/UX 調整 _(1 週間)_

* オンライン状態を示すインジケータを OFF にするか、ローカル保存状況を表示
* エラー文言を「ネットワーク」ではなく「ローカルデータ」に合わせて更新

---

## 8. ビルド & デプロイパイプライン _(1 週間)_

* CI で `npm run build:standalone` を追加（環境変数で API 実装切り替え）
* GitHub Pages / Netlify への自動デプロイ

---

## 9. QA & テスト _(継続)_

* Cypress：オフラインモードで E2E テストを実行
* Vitest：API Facade に対するユニットテスト
* Lighthouse：PWA 対応スコア 90+ を目標

---

## 10. マイルストーンまとめ

| Phase | 期間 | 完了条件 |
| ----- | ---- | -------- |
| 0-1 | 3 週 | 依存関係リスト & 代替案決定 |
| 2 | 1 週 | IndexedDB スキーマ確定 & 実装開始 |
| 3-4 | 3 週 | API Facade 完全導入 & 認証切替完了 |
| 5 | 2 週 | PWA インストール & オフライン起動成功 |
| 6-8 | 4 週 | 同期機構・エクスポート機能・CI デプロイ完了 |
| 9 | 継続 | テスト自動化・スコア達成 |

---

## 付録：技術スタック候補

* **Dexie.js**：IndexedDB ラッパー（型安全 & トランザクション）
* **Workbox**：Service Worker ジェネレーター
* **Comlink**：Web Worker でデータ処理をオフロード
* **Vite**：静的ビルド＆ESM 出力
* **TypeScript**：`any` 禁止ポリシーを厳守

---

### 注意事項

* セキュリティ➡️ ローカルストレージに機密情報を保存しない。
* パフォーマンス➡️ 大量データは Web Worker 経由で処理。
* ユーザサポート➡️ データ消失リスクを事前に周知し、バックアップ手順を提供。

---

このロードマップを基に、各フェーズごとのタスクブレイクダウンとチケット起票を行ってください。