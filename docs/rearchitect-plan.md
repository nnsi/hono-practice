# Actiko 再設計検討メモ

2026-03-02 時点の議論をもとに整理。

---

## 提案したが撤回したもの

### 1. オフラインファースト廃止 → サーバーファースト + Optimistic Updates

**撤回理由**: モバイルアプリが本命であり、回線不安定な環境での利用が前提。「最速で記録する」というアプリの思想にもオフラインファーストは合致している。TanStack Queryのoptimistic updateでは真のオフライン対応にならない。

### 2. 自前Sync Engine廃止 → PowerSync等の外部Sync製品採用

**撤回理由**: PowerSync・ElectricSQL等はまだ若いプロダクトで、個人開発の基盤に据えるにはベンダーリスクが高い。自前Syncはメンテコストと引き換えに完全なコントロールを得ている。収益化後に検討するレベル。

### 3. パッケージ大幅統合（7 → 1）

**撤回理由**: `frontend-shared` でhooksを共有する設計は、コーディングエージェント運用において「1箇所の修正でWeb/Mobile両対応 + テストで検知」を実現している。モバイルMVPとしてのWeb版という位置づけを考えると、パッケージ分割に合理性がある。

### 4. Backend Handler層の廃止（4層 → 3層）

**撤回理由**: Handler層はHonoへの依存を隔離し、フレームワーク差し替えを可能にする設計意図がある。v1では責務分離が機能している。ただしv2はRoute直書きからレイヤーだけ形式的に合わせた状態なので、v1相当の責務分離に修正する余地はある（後述）。

### 5. React Native廃止 → PWA

**撤回理由**: iOSのPWA制約（通知、バックグラウンド処理等）が依然として大きい。Expo OTAで高速にアップデートを配信できるメリットもある。ネイティブアプリが最終形。

### 6. 自前認証廃止 → Clerk等の外部サービス

**撤回理由**: 習作として1から構築した経緯があり、現状動いている。積極的に移行する理由がない。やるとしても優先度は低い。

### 7. DB Repository抽象の乖離懸念

**撤回理由**: 調査の結果、`packages/domain/` にRepository型を定義し、Web (Dexie) / Mobile (expo-sqlite) 両方が `satisfies` で準拠するクリーンな設計になっていた。shared hooksにプラットフォーム固有コードは一切漏れていない。

---

## 今後やるべきこと

### 優先度: 高

#### Sync E2Eテストの強化

モバイル本命のアプリにおいて、Syncの信頼性 = アプリの信頼性。過去に以下のバグが発生しており、自動テストで再発を防ぐ必要がある:

- DB空 + LAST_SYNCED_KEY残存 → フル同期されない
- `handleClearData` の `db.delete()` 問題
- アカウント切替時のデータ汚染

カバーすべきシナリオ:
- オフライン編集 → オンライン復帰 → 同期完了
- 同期中のネットワーク切断 → 復帰 → リトライ
- アカウントA → ログアウト → アカウントB → データ汚染なし
- 大量データのチャンク同期（100件境界）
- コンフリクト解決（ローカル変更 vs サーバー変更）

#### types / types-v2 の統合

v1 frontendは削除済み。`packages/types` と `packages/types-v2` が並存する理由がなくなっているので、1つに統合する。

#### Backend v1/v2 feature の統合

v1 frontendが削除された以上、backend側の `/feature/` (v1) と `/feature-v2/` の並存も整理対象。使われていないv1エンドポイントの特定と削除、またはv2への統合を進める。

### 優先度: 中

#### Backend v2のHandler層を v1相当の責務分離に修正

v2は元々Route直書きから形式的にレイヤーを合わせただけの状態。v1のようにHandler層が「Honoからの隔離」という明確な責務を持つ形に修正する。

#### api-contract パッケージの廃止

backendのApp型をre-exportしているだけなので、同一monorepo内であれば直接importで十分。パッケージを1つ減らせる。

### 優先度: 低

#### 認証の外部サービス移行

現状動いており緊急性はない。収益化やユーザー数増加に伴いセキュリティ要件が上がった時点で検討。Clerk、Better Auth等が候補。
