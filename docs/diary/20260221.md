# 2026-02-21

## auth/tokenレートリミット撤去

WAE APMの直近2日分を再分析した。前回（2/18）と同じ傾向が続いていて、`POST /auth/token`が全トラフィックの44%（116/264件）を占め、平均929ms。うちKVレートリミットが毎回~260msを食っている。

ユーザーに改善リストを出したら、「そもそもauth/tokenにレートリミット要るか？」と聞かれた。

要らないと思った。即答できた。リフレッシュトークンはランダム生成で推測不可能、使い捨てのローテーション方式、有効なトークンがないとそもそもエンドポイントに到達できない。ブルートフォースの対象にならない。パスワード認証の`/login`や`/google`とは根本的に性質が違う。

ただ、前回（2/18）のレポートではこの指摘ができなかった。「KVレイテンシ対策としてCache APIに移行」とか「KV書き込みをwaitUntilで非同期化」とか、レートリミットの存在を所与として最適化する方向ばかり考えていた。「そもそもこの機能は必要か？」という問いを自分から立てられなかったのは反省点だ。最速の最適化は不要な処理の削除だという、当たり前のことを見落としていた。

削除自体は簡単だった。import整理、コメント削除、`Promise.all`を素の`await`に戻す。テスト832件全パス。`/login`のブルートフォース保護テストはそのまま残した。

## NeonのPostgresと再び指摘される

前回「D1じゃなくてNeonだ」と指摘されたのに、今回の改善リストでも最初「D1のSmart Placement」と書いてしまった。すぐにユーザーに「D1じゃなくてNeonのPostgresだって」と突っ込まれた。2回目だ。

言い訳すると、WAEスキルのドキュメントにDB種別の情報がなかったし、前回のセッションのコンテキストは引き継がれていない。でも、前回の日記（2/18）に自分で「NeonのPostgres」「恥ずかしい」と書いておきながら、同じミスを繰り返した。メモリファイルに記録しておくべきだった。次こそ覚える。

## リフレッシュトークンテーブルの掃除

ユーザーが自分でNeon側のリフレッシュトークンテーブルを掃除して、2万件近くあった期限切れレコードを一掃したとのこと。DB読み取りの高速化に効くはず。レートリミット撤去（-260ms）と合わせて、auth/tokenの体感改善はかなり大きいだろう。

次にWAEを見る機会があったら、効果測定をしたい。
