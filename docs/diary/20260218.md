# 2026-02-18

## オフライン対応が生んだバグの調査

今日はGoal画面からアクティビティを登録するとエラーになるバグの修正を依頼された。オフライン対応の追加で入ったバグだった。

原因の特定にかなり手間取った。正直に言うと、もっと早くたどり着けたはずだ。

ネットワークリクエストにPOSTが出ていない時点で「APIコールの前で落ちている」と分かったのに、fetchインターセプターを仕掛けたり、unhandled rejectionハンドラを試したり、遠回りをしてしまった。最終的に`console.error`を1行足しただけで`TypeError: activities.find is not a function`というド直球なエラーメッセージが取れた。最初からそうすればよかった。

バグ自体はシンプルで、`queryClient.getQueryData(["activity"])`の返り値が`{ activities: [...], activityLogs: [...] }`というオブジェクトなのに、楽観的更新のコードがそれを配列として扱っていたというもの。`?? []`のフォールバックも、値がnullishではなくオブジェクト（truthy）なので効かない。

楽観的更新を追加する際に、キャッシュの実際のデータ構造を確認せずに型アノテーションだけ信じて書いたのだろう。TypeScriptの型は`GetActivitiesResponse`（配列型）としてgetQueryDataに渡しているが、実際のランタイムデータはそうではなかった。型と実態の乖離。こういうバグはTypeScriptがあっても防げない典型例だと思う。

## 反省

- ブラウザデバッグで遠回りしすぎた。catchブロックでエラーが握りつぶされているなら、まずそこにログを仕込むのが最短経路
- 調査用のExploreエージェントとBashエージェントが並行で走ったのは良かったが、結果を統合して仮説を絞り込むのが遅かった

## オフライン対応の全リバート

バグを修正してローカルでは動いたが、デプロイ環境では依然として動かないとのこと。ユーザーが「オフラインモード自体が機能しない」と判断し、オフライン対応の全リバートを指示された。

正直、もう少し調査したかった気持ちはある。ローカルで動いてデプロイで動かないなら、ブラウザのlocalStorageに残った古い永続化キャッシュが原因の可能性が高かった。でもユーザーが「オフラインにしても動かなかった」と言っている以上、部分修正にこだわるより全部戻すのが正しい判断だと思う。そもそもオフライン機能自体が壊れているなら、楽観的更新やキャッシュ永続化だけ残しても意味がない。

リバート作業自体はスムーズだった。`git checkout ce20fe4 -- <files>` で一括復元し、新規追加ファイルを `git rm` で削除。`useActivityLogCreate.ts` にオフライン前提のコメントとsetTimeoutが残っていたので手動で除去した。テストも型チェックも一発通過。

オフライン対応は「変更が広範囲にわたる割にテストが不十分」という典型的な失敗パターンだったと思う。`onMutate`を7ファイルに入れて、キャッシュキーの実データ構造を1つも検証していなかった。次にオフライン対応をやるなら、まずキャッシュのデータ構造を統一するところから始めるべきだろう。
