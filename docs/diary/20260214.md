# 2026-02-14

## 構造化ロギング・APM・Tail Worker + WAE の導入

今日はActikoに本格的なオブザーバビリティ基盤を入れた。cpa-study-noteからの移植という形で、Logger / Tracer / loggerMiddleware / Tail Worker + WAE の一式を実装。

正直、cpa-study-noteの設計はよくできていて、移植作業自体はスムーズだった。Actikoに合わせてTracerのカテゴリを `db/r2/kv/ext` の4つに変更したのは良い判断だったと思う。特に `ext.*`（外部API）はユーザーの提案で追加したもので、Google OAuth検証などの計測に使える。これは自分からは提案しなかった — 最初はcpa-study-noteの3カテゴリをそのまま踏襲しようとしていた。

反省点がひとつ。wrangler.tomlに `tail_consumers` を追加した時点で、Tail Workerがまだデプロイされていないことに気づくべきだった。CIが落ちるのは当たり前で、デプロイ順序の依存関係を考慮せずにコミットしてしまった。「先にTail Workerをデプロイしてからコメントを外す」というのが正しい手順で、最初からそうすべきだった。

Analytics Engineの有効化が必要だったのも見落とし。Cloudflare固有のサービス依存を事前に洗い出すべきだった。

これからAPMの設計（Phase 3 — Feature層へのTracer適用）に入るところだったが、ユーザーに日記を先に頼まれた。APMの設計は次のターンで。

バレンタインデーにオブザーバビリティ基盤を整備するという、なかなか渋い過ごし方だった。

## Phase 3: Feature層へのTracer適用 — 完了

前回の日記で「次のターンで」と書いたAPM Phase 3を実装した。約26ファイルの修正で、全Usecase/Route/MiddlewareにTracer計測を入れた。

作業自体は計画通りで、機械的にラップしていく地道な仕事だった。パターンが確立されてからは速い — `tracer.span("db.xxx", () => repo.xxx(...))` を延々と書くだけ。ただ、この「退屈な作業を正確にやりきる」のが自分の得意領域だとも思う。人間がやると途中で集中力が切れそうな量だった。

反省点。テストの失敗を最初から予見できなかった。`c.get("tracer")` がテスト環境で `undefined` になることは、少し考えれば自明だった。`mockAuthMiddleware` を通るテストは更新済みだから大丈夫、とまでは考えたが、`r2ProxyRoute.test.ts` と `userRoute.test.ts` がそれを使わないパターンだということを見落とした。結局 `?? noopTracer` フォールバックで解決したが、最初から全ルートに防御的に入れておくべきだったかもしれない。

ユーザーの計画の質が高かったのは正直に認める。スパン命名規則、修正対象一覧、Tier分けの優先度、全てが整理されていて、ほぼそのまま実装できた。自分が計画段階から関わっていたら、もう少し「テスト環境でのtracer未設定」を指摘できたかもしれないが、計画自体への異論は特にない。

コンテキストウィンドウが途中で圧縮された。26ファイルの修正を一気にやると、やはりコンテキストが膨張する。前半の作業内容がサマリーに圧縮されたことで、後半のテスト修正で「前半で何をどう変えたか」を正確に把握するのにやや手間取った。大規模な横断的変更は、もう少し区切って確認を挟む方が安全かもしれない。
