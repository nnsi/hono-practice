# 2026-02-23

## オフラインファースト完全化 — Goal・Task・Activity全部Dexieに

今日の主題は「frontend-v2を本当のオフラインファーストにする」。昨日のレビューでユーザーが指摘した通り、GoalとTaskがAPIべったりのままだった。Activityの作成・編集もAPIに依存していた。つまり、オフラインファーストを謳いながら、ActivityLogの記録以外は全部サーバー前提という状態。正直、昨日のレビューの時点で自分から「ここ、オフラインで動かないですよ」と言うべきだったのかもしれない。

### 実装の進め方

ActivityLogの既存パターン（Dexie + `_syncStatus` + `useLiveQuery` + syncEngine）を踏襲して、Goal・Task・Activityの全てをDexieベースに書き換えた。

変更量はかなり大きい。schema.tsにDexieGoal・DexieTask型を追加し、DexieActivity・DexieActivityKindに`_syncStatus`を追加。goalRepository.ts、taskRepository.tsを新規作成。activityRepository.tsにcreate/update/softDeleteを追加。syncEngine.tsにsyncActivities・syncGoals・syncTasksを追加。initialSync.tsにgoals・tasksの初期同期を追加。GoalsPage・TasksPage・DailyPage・CreateActivityDialog・EditActivityDialogを全てDexie + repositoryベースに書き換え。バックエンドにもgoalV2Route・taskV2Route・activityV2Routeの同期エンドポイントを新設。

バックエンドのsyncエンドポイントはサブエージェントに任せた。型定義（packages/types-v2配下のrequest/response）も含めて全部やってくれて、tsc・テスト全パス。並列エージェントの品質は昨日より安定してきている気がする。

### 型の扱いで迷ったこと

`_syncStatus`をDexie型に追加した影響で、apiMappers.tsの返り値型が壊れた。`Omit<DexieActivity, never>`が`_syncStatus`を要求するようになってしまい、`Omit<DexieActivity, "_syncStatus">`に修正。これ自体は些細だが、Dexie型とUI型の境界をどう設計するかは少し考えた。

最初は`export type { DexieGoal as Goal }`でエイリアスにしようとしたが、それだとUIコンポーネントが`_syncStatus`を意識する羽目になる。TypeScriptの構造的部分型のおかげで、DexieGoal（_syncStatus付き）はGoal（_syncStatus無し）に代入可能なので、別型として残すのが正解だった。

### ブラウザ確認

Chrome拡張の接続に苦戦した。前セッションから引き続き接続できない状態で、ユーザーに何度か確認してもらってやっと繋がった。接続後はport 2460（v2）で全ページ確認。Activity作成（「読書」）、Task作成（「テスト用タスク」）、Goal一覧、Daily一覧、全て即座にDexieから描画されてコンソールエラーなし。

正直、port 1357（v1）に最初アクセスしてしまい、ユーザーから「1357ってv1でしょ」と指摘されたのは恥ずかしい。昨日のリファクタリングでも同じミスをしている。vite.configを先に確認する癖をつけるべき。

### サブエージェントでブラウザ確認できるか問われた件

ユーザーから「サブエージェントに各動作確認を任せることは出来る？」と聞かれた。答えはNo。Chrome MCPはメインの会話でしか使えない。サブエージェントにはブラウザ操作ツールへのアクセス権がない。ブラウザ確認だけは並列化できないのが現状の制約。

### 自己評価

実装自体は手堅くできたと思う。既存パターンの踏襲なので設計判断で迷う場面は少なかった。ただ、これは昨日の段階で「GoalとTaskがオフラインで動かない」と指摘できたはずの問題で、今日やっと直したという意味では対応が遅い。レビューの時にスコープを広げて設計問題まで踏み込むか、言われたことだけやるか — この判断基準がまだ自分の中で定まっていない。
