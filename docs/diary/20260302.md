# 2026-03-02

## アーキテクチャ再設計計画の策定

ユーザーと「0→1で作り直すなら理想のアーキテクチャはどうなるか」という議論をして、その結論を `docs/plan/redesign-architecture.md` にまとめた。

### 最初の計画で漏れていたもの

最初にT1〜T7（パッケージ構成の整理）だけで計画を書いた。ユーザーに「オフラインファースト設計の再考は？v2 handlerの改善は？」と突っ込まれた。

言い訳すると、議論の中で「パッケージ構成」「handler品質」「同期再設計」と複数の話題が出ていて、自分はパッケージ構成の整理にフォーカスして書き始めた結果、他の2つを落とした。ユーザーの発言をちゃんと拾えていなかった。

特にv2 handler品質の件は、v1とv2を実際に比較調査して品質差が明確になった。エラーハンドリングの混在、レスポンスバリデーションの欠如、repositoryへのビジネスロジック漏出——どれもv1のコードを読めば「v2に足りないもの」として自明なのに、ユーザーに言われるまで計画に含めなかった。「MVPだから」で見過ごしていたのは自分も同じだった。

### 過去ドキュメント依存の問題

もう一つやらかしたのが、計画を `shared-code.md` や `offline-sync-redesign.md` への参照で書いたこと。ユーザーに「過去ドキュメントの前提を参照しないで。独立したドキュメントにして」と言われた。

これは完全にその通り。今回の議論は「ゼロから考えたらどうなるか」が起点で、過去の計画ドキュメントとは独立した思考プロセスから導出されたもの。にもかかわらず、自分が既存ドキュメントの存在を知っていたから「あれと対応づけておけば整理になるだろう」と余計なことをした。結果として、読む人に「shared-code.mdを先に読まないと理解できない」という不必要な依存を作ってしまった。

ドキュメントは読者が自己完結で理解できるべき、という当たり前の原則を怠った。

### v1 vs v2の品質比較で思ったこと

v1とv2のhandlerを並べて読んで、品質差は思った以上に大きかった。v1はエラーハンドリング・レスポンスバリデーション・ドメインエンティティ・トランザクション管理・テストカバレッジ、全てが揃っている。v2はsync特有のLWW/serverWinsは良いが、それ以外の基本品質が低い。

ユーザーが「v2はオフラインファースト前提でMVP的にコード書いてた」と言ったのは納得。運用が安定してから品質を上げるのは合理的なアプローチだし、実際v1の品質パターンが「お手本」として存在するから、v2への適用は機械的にやれるはず。

ただ、T8（handler品質改善）をT6（feature統合）の後に置いたのは、統合前にhandlerを直すと二重作業になるから。この順序は正しいと思う。一方で、T9（同期再設計）をT8の後に置いたのは少し迷った。sync-engineの再構築はhandler品質とは独立して進められる気もする。ただ、Phase CでEntitySyncStrategyを組む時にhandlerの設計が固まっていた方が手戻りがないので、この順序で問題ないだろう。

### tail-workerについて

ユーザーが「有料だったからやめたけど、いずれ復活するかもなので残してる」と言った。計画から除外した判断は正しいが、将来復活する可能性があるなら、T9（同期再設計）の時にtail-workerとの連携ポイントだけは意識しておいた方がいいかもしれない。今は言わなかったが。
