# 2024-12-24 開発日記

クリスマスイブにセキュリティ修正とレートリミット実装。なかなか濃い一日だった。

## やったこと

### 1. セキュリティ修正（タスク1, 2）

- **bcrypt移行**: `passwordVerifier.ts`の`hash()`をSHA256からbcryptに変更。既存ユーザーはSHA256のままログインできて、新規・パスワード変更時はbcryptになる。シンプルな変更だけど重要。

- **パストラバーサル対策**: バッチエンドポイントで`..`や`%2e`を検出してブロック。ホワイトリストは見送り。

テストも書いて、すんなり完了。

### 2. レートリミット実装

ここからが本番。`hono-rate-limiter`は使わず、素朴な固定ウィンドウ方式で自前実装。

**構成**:
- `apps/backend/middleware/rateLimitMiddleware.ts` - ミドルウェア本体
- `apps/backend/infra/kv/redis.ts` - Redis KVアダプター

`KeyValueStore<T>`インターフェースを活かして、ローカルはRedis、本番はDurable Objectsで切り替えられる設計にした。

**ハマりポイント**: Redisクライアントの型。最初は`RedisClientType`を使おうとしたけど、5つもジェネリックパラメータがあって複雑すぎた。結局`ReturnType<typeof createClient>`で解決。シンプルが一番。

### 3. Durable Objects実装

stg/本番向けにDOを実装。ここが一番学びが多かった。

**ファイル配置の議論**:
最初は`apps/backend/infra/do/`を考えたけど、DOはCloudflareインフラに近いので`/infra/do/kvs.ts`（ルートレベル）に配置。`/infra/drizzle/`と同じ階層感で、しっくりきた。

**wrangler.tomlのハマり連発**:

1. **環境継承されない問題**
   ```toml
   # これだとenv.stgに継承されない！
   [[durable_objects.bindings]]
   name = "RATE_LIMIT_DO"
   ```
   環境ごとに明示的に書く必要があった。警告出てたのに最初スルーしてた...

2. **無料プランの制約**
   ```
   error TS10097: In order to use Durable Objects with a free plan,
   you must create a namespace using a `new_sqlite_classes` migration.
   ```
   `new_classes`じゃなくて`new_sqlite_classes`。知らなかった。

3. **stub.fetchのURL問題**
   ```
   TypeError: Invalid URL: /get
   ```
   DO stubの`fetch()`には完全なURLが必要。`/get`じゃなくて`http://do/get`。Context7で公式ドキュメント調べて確認できた。最初は疑われたけど、ちゃんとエビデンス出せてよかった。

## 感想

DOまわりは初めてちゃんと触ったので、想定外のエラーが多かった。でも一つずつ潰していくのは楽しい。

「本当に合ってる？」って突っ込まれたときは一瞬焦ったけど、公式ドキュメントで裏取りできて安心した。思い込みで進めず、ちゃんと確認する大事さを再認識。

クリスマスイブにセキュリティ対策してる自分、なかなか渋い。

## 今後

- 手動での動作確認（レートリミットが実際に効いてるか）
- 本番デプロイ
- 監視・アラート設定（429が多発したら気づけるように）

---

**変更ファイル一覧**:
- `apps/backend/feature/auth/passwordVerifier.ts`
- `apps/backend/app.ts`
- `apps/backend/middleware/rateLimitMiddleware.ts` (NEW)
- `apps/backend/infra/kv/redis.ts`
- `apps/backend/infra/kv/do.ts`
- `apps/backend/server.node.ts`
- `apps/backend/server.cf.ts`
- `apps/backend/config.ts`
- `apps/backend/context/index.ts`
- `infra/do/kvs.ts` (NEW)
- `wrangler.toml`
- `.github/workflows/deploy.yml`
