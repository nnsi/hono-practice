# Frontend V2: フルオフラインファースト移行

## ステータス

決定

## コンテキスト

2025年6月にハイブリッド方式（Web接続必須 + 記録のローカル保存）を採用した（`20250612_offline_hybrid_approach.md`）。localStorage + Navigator.onLine API による最小限のオフライン対応だった。

運用を経て、以下の課題が明らかになった：

- localStorage はストレージ容量が小さく（5MB）、構造化データのクエリに不向き
- 「Web読み込みにネット必須」という制約が「最速記録」のコンセプトと矛盾する
- バックエンドのレスポンス最適化（レートリミット撤去、複合インデックス追加、JOINの削減）を進めたが、ネットワーク往復そのものが最大のボトルネックであることが判明
- フロントエンドとバックエンドの両方にビジネスロジックが散在し、変更時に両方を修正する必要がある

### 検討した選択肢

1. **既存フロントエンドの段階的改善**: localStorage → IndexedDB に移行しつつ既存構造を維持
2. **frontend-v2 新規構築 + フルオフラインファースト**: Dexie.js + PWA + 同期エンジンで1から構築
3. **React Native + React Native Web**: クロスプラットフォーム対応を兼ねた新規構築

## 決定事項

**選択肢2: `apps/frontend-v2` をフルオフラインファーストで新規構築する**

### アーキテクチャ

- **ローカルDB**: Dexie.js（IndexedDB ラッパー）。全データをクライアントに持ち、`useLiveQuery` でリアクティブにUIへ反映
- **PWA**: vite-plugin-pwa で Service Worker + マニフェスト生成。アプリとしてインストール可能、オフライン起動対応
- **ID生成**: UUID v7 をクライアントで生成。サーバーへの依存なしに即座にレコード作成
- **同期戦略**: Last-write-wins。クライアント生成 → バックグラウンドでサーバーへバッチ同期。`ON CONFLICT DO UPDATE` で upsert
- **バックエンド**: `/users/v2/` に薄い CRUD エンドポイント。usecase/repository 層なし、Drizzle 直書き。データ保存に徹する

### 選択肢3（React Native Web）を却下した理由

- RN Web のブリッジ層がパフォーマンスのオーバーヘッドになる
- バンドルサイズが純粋な React SPA より大きくなる
- 既存の Radix UI + TanStack Router 資産を捨てることになる
- PWA でモバイルインストール + オフライン対応は十分実現可能

### 選択肢1（段階的改善）を却下した理由

- 既存フロントエンドは TanStack Query 中心の設計で、Dexie ベースのデータフローに移行するには大規模な書き換えが必要
- 並行して新規構築した方が、既存を壊さずに検証できる

### パッケージ構成

| パッケージ | 役割 |
|---|---|
| `packages/domain` | 同期プロトコル用フラット型 + Zod バリデーション |
| `packages/types-v2` | v2 API の Request/Response 型 |
| `apps/frontend-v2` | オフラインファースト SPA |
| `apps/backend/feature-v2/` | v2 CRUD エンドポイント |

### npm → pnpm 移行

このタイミングで npm workspaces から pnpm に移行する。mobile 削除 + 新パッケージ追加という大きな構造変更の前に実施し、以降の依存管理を厳密にする。

## 結果

### ユーザーへの影響

**ポジティブ:**
- ネットワーク完全不要で記録可能（ゼロレイテンシ）
- PWA としてインストール可能。ネイティブアプリに近い体験
- オフラインで蓄積 → オンライン復帰時に自動同期

**制約:**
- 初回ログイン時のみネット接続が必要（activities マスタデータの取得）
- MVP では activity の作成・編集は v1 フロントエンドで行う
- 統計・目標管理は MVP 後に実装

### システムへの影響

**フロントエンド:**
- データの正（Source of Truth）が Dexie（クライアント）に移る
- TanStack Query は不使用。`useLiveQuery` で Dexie → UI のリアクティブバインディング
- 同期エンジンがバックグラウンドで差分をサーバーへ送信

**バックエンド:**
- `/users/v2/` 配下に同期エンドポイントを追加（既存 v1 に影響なし）
- ビジネスロジックはフロントエンドに移動。バックエンドは upsert + 読み取りのみ
- 既存 DB スキーマは変更なし（UUID v7 は既存の uuid カラムと互換）

**既存フロントエンド:**
- `apps/frontend`（v1）はそのまま残す。MVP 検証後に入れ替え判断

### 前回 ADR（20250612）との関係

前回のハイブリッド方式を **発展的に置き換える**。ハイブリッド方式で得た知見（同期ロジック、オフライン利用パターン）を踏まえ、フルオフラインファーストに移行する。

## 備考

### MVP 完了条件

1. ログイン → activities 取得 → Dexie 保存
2. ワンタップ記録 → Dexie 即保存 → UI 即反映
3. オンライン時にバックグラウンド同期
4. ページリロードでデータ復元
5. オフライン記録 → オンライン復帰時に自動同期
6. PWA インストール可能

### 詳細計画

`docs/plan/frontend-v2.md` に Phase 1a〜5 の実装計画を記載。3つのレビュアー（アーキテクチャ、実装フィージビリティ、Codex GPT-5.3）から LGTM 取得済み。
