# 認証フロー

## 概要

本アプリケーションでは、JWT形式のアクセストークンとリフレッシュトークンを組み合わせた認証方式を採用しています。
また、Google OAuth認証もサポートしています。

### トークンの仕様

- アクセストークン
  - 形式: JWT
  - 有効期限: 15分
  - 保存場所: メモリ（React Context）
  - 用途: APIリクエスト時の認証
  - 送信方法: Authorizationヘッダー（Bearer トークン）

- リフレッシュトークン
  - 形式: ランダム文字列
  - 有効期限: 1ヶ月
  - 保存場所: httpOnlyクッキー
  - 用途: アクセストークンの更新

## 認証フロー詳細

### 1. 初回起動時の認証状態確認

1. アプリケーション起動時にAuthProviderがマウント
2. `/auth/token`エンドポイントにリクエストを送信
3. リフレッシュトークン（クッキー）が有効な場合
   - 新しいアクセストークンを取得してメモリに保存
   - ユーザーは自動的にログイン状態となる
4. リフレッシュトークンが無効または存在しない場合
   - ログイン画面へリダイレクト

### 2. ログイン（通常認証）

1. ユーザーがログイン情報（ユーザー名/パスワード）を入力
2. `/auth/login`エンドポイントに認証リクエストを送信
3. 認証成功時
   - アクセストークンをレスポンスボディで受け取り、メモリに保存
   - リフレッシュトークンはhttpOnlyクッキーとして自動設定
4. AuthProviderがトークンを管理し、認証状態を更新

### 3. ログイン（Google OAuth認証）

1. ユーザーがGoogleログインボタンをクリック
2. Google OAuth認証フローを開始
3. Googleから認証コードを取得
4. `/auth/google`エンドポイントに認証コードを送信
5. バックエンドでGoogleトークンを検証し、ユーザー情報を取得
6. 認証成功時
   - 新規ユーザーの場合は`users`テーブルに作成
   - `user_providers`テーブルに関連付けを保存
   - 通常認証と同様にトークンを発行

### 4. APIリクエスト時の認証処理

1. APIリクエスト時にアクセストークンをAuthorizationヘッダーに付与
   - 形式: `Authorization: Bearer {token}`
2. バックエンドでトークンの検証
3. 検証結果に応じて以下の処理を実行
   - 成功: リクエストを処理
   - 失敗（401）: クライアント側でトークン期限切れを検知

### 5. アクセストークン更新処理（自動）

1. アクセストークンの有効期限が14分を超えた場合
   - AuthProviderが自動的に更新処理を開始
2. `/auth/token`エンドポイントにリクエストを送信
   - リフレッシュトークンはクッキーで自動送信
3. 更新成功時
   - 新しいアクセストークンをメモリに保存
   - APIリクエストは通常通り処理される
4. 更新失敗時
   - ログアウト処理を実行
   - ログイン画面にリダイレクト

### 6. ログアウト

1. `/auth/logout`エンドポイントにリクエストを送信
2. バックエンドでリフレッシュトークンを無効化
3. クッキーから削除（Max-Age=0を設定）
4. メモリからアクセストークンを削除
5. ログイン画面にリダイレクト

## エラーハンドリング

### 1. アクセストークン期限切れ

- 自動的にリフレッシュトークンを使用して更新を試みる
- 更新成功時はユーザーに影響を与えない
- 更新失敗時はログアウト処理を実行

### 2. リフレッシュトークン期限切れ

- ログアウト処理を実行
- ログイン画面にリダイレクト
- ユーザーに再ログインを促す

### 3. その他の認証エラー

- エラーメッセージをユーザーに表示
- 必要に応じてログアウト処理を実行

## セキュリティ対策

1. トークンの保存
   - アクセストークン: メモリ内で管理（XSS攻撃時の被害を最小化）
   - リフレッシュトークン: httpOnlyクッキー（JSからアクセス不可）
   - SameSite属性: Strict（CSRF攻撃を防止）
   - Secure属性: 本番環境でHTTPS通信のみ

2. APIリクエスト
   - すべてのAPIリクエストにHTTPSを使用
   - アクセストークンはAuthorizationヘッダーで送信
   - CORS設定で許可されたオリジンのみアクセス可能

3. トークンの無効化
   - ログアウト時に確実にトークンを無効化
   - 期限切れトークンは自動的に無効化
   - リフレッシュトークンはDBで管理し、無効化可能

4. Google OAuth
   - 認証コードの検証はバックエンドで実施
   - プロバイダーIDとユーザーIDの関連付けを管理

## 実装上の注意点

1. トークン更新処理
   - 複数のAPIリクエストが同時に失敗した場合の競合を考慮
   - 更新処理中は他のAPIリクエストを待機させる

2. エラーハンドリング
   - ユーザーに適切なフィードバックを提供
   - エラー状態からの回復処理を確実に実装

3. セッション管理
   - トークンの有効期限を定期的にチェック
   - 不要なトークンは確実に削除
